name: build-commit

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Execute Gradle build
        run: ./gradlew build

      - name: Extract branch name
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi
        id: ref

      # Find the correct jars and move them to clean folders
      - name: Stage Artifacts
        run: |
          mkdir -p staged/fabric staged/neoforge staged/forge
          
          # Find jars, excluding -dev and -sources, and copy them to staged folders
          find fabric/build/libs -maxdepth 1 -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" -exec cp {} staged/fabric/ \;
          find neoforge/build/libs -maxdepth 1 -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" -exec cp {} staged/neoforge/ \;
          find forge/build/libs -maxdepth 1 -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" -exec cp {} staged/forge/ \;

      - name: Upload Fabric Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fabric-${{ steps.ref.outputs.branch }}
          path: staged/fabric/*

      - name: Upload NeoForge Artifact
        uses: actions/upload-artifact@v4
        with:
          name: neoforge-${{ steps.ref.outputs.branch }}
          path: staged/neoforge/*

      - name: Upload Forge Artifact
        uses: actions/upload-artifact@v4
        with:
          name: forge-${{ steps.ref.outputs.branch }}
          path: staged/forge/*
